#!/usr/bin/ksh
# takes a worpress xml export file on $1 as input

xmlstarlet sel -T -N wp=http://wordpress.org/export/1.0/ <"$1" \
               -N content="http://purl.org/rss/1.0/modules/content/" \
               -t -m "rss/channel/item[wp:post_type='post']" \
               -o '$#@NEWPOST' -n  \
               -o '$#@POSTTITLE: ' -v title -n \
               -o '$#@POSTPUBLISHED: ' -v pubDate -n \
               -o '$#@POSTID: ' -v wp:post_id -n |
   awk '
      /\$\#\@NEWPOST/ {
         FILENAME=""
         POSTED=""
      }
      /\$\#\@POSTTITLE/ {
         $1="";
         sub(" ","");
         gsub(/[\"]/, "")
         FILENAME="posts/"$0".html"
      }
      /\$\#\@POSTPUBLISHED/ {
         $1="";
         sub(" ","");
         POSTED=$0
      }
      /\$\#\@POSTID/ {
         $1="";
         sub(" ","");
         # localhost/wp is a special themed wp, which only serves the
         # entry-content for each post, if you do not want to invest
         # to much effort, you can alternatively pipe the full html
         # page to xmlstarlet to select the entry-content div value,
         # but this is left as an excercise for the reader.
         system("xmlstarlet sel -T -N wp=http://wordpress.org/export/1.0/ -N content=http://purl.org/rss/1.0/modules/content/ -t -m \"rss/channel/item[wp:post_type='\''post'\'' and wp:post_id="$0"]\" -v content:encoded <\"'$1'\" >\""FILENAME"\"");

         # very important, this defines the order of our posts in the 
         system("touch -d " "\""POSTED"\"" " \""FILENAME"\"");
      }
      '
