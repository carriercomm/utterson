#!/usr/bin/ksh
# generates an atomfeed and static html blog pages from
# posts/*.html files, containing the entry content of the posts, the
# filename is used as a title, the last modification time as
# lastupdate.
#
# TODO tags, blog search

. ${0%%/*}/utterson.cfg
. ${0%%/*}/utterson.lib

########### start processing #############

postslen=${#@}

# get timestamp of very last post for rss
TVARS[LASTUPDATED]="$(getRFCtime "${1}")"

#### MAIN LOOP STARTS HERE ####

counter=0
# process posts
for entry; do
    [[ $((counter % ITEMMAX)) == 0 ]] && {
        # write out headers
        # atom is only generated for the first ITEMMAX posts
        [[ $((counter / ITEMMAX)) == 0 ]] &&
            runtpl atom header >"${TMPDIR}/${ATOMFILE}"
    }

    fname="${entry##*/}"
    TVARS[POSTTITLE]="${fname%.html}"
    TVARS[POSTUPDATED]="$(getRFCtime "$entry")"
    TVARS[POSTUPDATEDSHORT]="$(stat -c "%y" "$entry" | cut -d" " -f1)"
    TVARS[POSTCONTENT]="$(filter "$entry")"
    TVARS[POSTURL]="posts/${fname// /_}"
    TVARS[PAGETITLE]="${TVARS[BLOGTITLE]} - ${TVARS[POSTTITLE]}"

    [[ $((counter / ITEMMAX)) -eq 0 ]] &&
        runtpl atom item >>"${TMPDIR}/${ATOMFILE}"

    # we have writen ITEMMAX posts, time to write some footers and
    # starts some new files
    [[ $((counter % ITEMMAX)) -eq $((ITEMMAX -1)) ]] && {
        dofooter
        runtpl atom footer >>"${TMPDIR}/${ATOMFILE}"
        break
    }
    counter=$((counter + 1))
done
