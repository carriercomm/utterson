#!/bin/zsh

. ${0%%/*}/utterson.lib
pages=""

# this function creates rules for index.html+page-X...Z.html style archives
# in the directory specified by the first parameter
# for all posts read via stdin
function car {
	i=0
	pages=""
	pagename="index.html"
	set -A allposts $(tr '\n' ' ')
	pagecnt=$((${#allposts[@]} / ${ITEMMAX} ))
   # set targetdir
   subdir="$1"
   if [[ -z "$subdir" ]]; then
       target="\$(TMPDIR)"
       ubertarget="echo archive: \$pages"
   else
       target="\$(TMPDIR)/${subdir}"
	    ubertarget="echo ${subdir}: \$pages \${target}/atom.xml"
   fi
	while [ $i -le ${pagecnt} ]; do
      # calculate range of items
		lbound=$((i*${ITEMMAX} +1))
		ubound=$((i*${ITEMMAX} +${ITEMMAX} ))

      # set next page link
		next=$((i+1))
		if [ $next -le $pagecnt ]; then
		    nextpage="page-$next.html"
		else
		    nextpage=""
		fi

      # set previous link
		prev=$((i-1))
		if [ $prev -eq 0 ]; then
		    prevpage="index.html"
		elif [ $prev -lt 0 ]; then
		    prevpage=""
		else
		    prevpage="page-$prev.html"
		fi

		pages="$pages $target/${pagename}"
		echo "$target/${pagename}: ${allposts[$lbound,$ubound]}"
   	echo "	@test -d \$(@D) || mkdir -p \$(@D)"
		echo "	ksh bin/page \"${subdir}\" \"$prevpage\" \"$nextpage\" "'$^'" >\$@"
		echo
		i=$((i + 1))
		pagename="page-$i.html"
	done
	echo "${target}/atom.xml: ${allposts[1,${ITEMMAX}]}"
   echo "	@test -d \$(@D) || mkdir -p \$(@D)"
	echo "	ksh bin/atom \$^ >\$@"
	echo
   eval "$ubertarget"
	echo
}

# reproduce header
cp Makefile.in Makefile

# create main index archive rules
/bin/ls -t -x posts/*.html | car ""

# create tag rules
for tag in $(ls -x ${CFGDIR}/tags/); do
	tags="$tags tags/${tag}"
   car "tags/$tag" <${CFGDIR}/tags/${tag}
done
echo "tags: ${tags}"
echo

#	create individual posts rules
i=1
set -A files $(/bin/ls -t -x posts/*.html )
while [ ${#files[@]} -ge $i ]; do
	#tname=posts/$$(f=$${files[i]##*posts/} ;echo $${f// /_} | urlencode)
	tname="${files[i]}"
	echo "\$(TMPDIR)/${tname}: ${files[i]}"
   echo "	@test -d \$(@D) || mkdir -p \$(@D)"
	echo "	ksh bin/post \"${files[i]}\" \"${files[i-1]}\" \"${files[i+1]}\" >\$@\n"
	postpages="$postpages \$(TMPDIR)/${tname}"
	i=$((i+1))
done
echo "posts: $postpages"
