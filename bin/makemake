#!/bin/ksh

cp Makefile.in Makefile
#	create page rules
set -A allposts $^
pagecnt=$$(($${#allposts[@]} / $(maxposts) ))
i=1
while [ $$i -lt $${pagecnt} ]; do
	lbound=$$((i*$(maxposts) +1))
	ubound=$$((i*$(maxposts) +$(maxposts) ))
	next=$$((i+1))
	if [ $$next -lt $$pagecnt ]; then
	    nextpage="page-$$next.html"
	else
	    nextpage=""
	fi
	prev=$$((i-1))
	if [ $$prev -eq 0 ]; then
	    prevpage="index.html"
	else
	    prevpage="page-$$prev.html"
	fi
	pages="$$pages \$$(TMPDIR)/page-$$i.html"
	echo "\$$(TMPDIR)/page-$$i.html: $${allposts[$$lbound,$$ubound]}"
	echo "	ksh bin/page \"\" \"$$prevpage\" \"$$nextpage\" "'$$^'" >\$$@"
	echo 
	i=$$((i + 1))
done
echo "pages: $$pages"
echo
echo "archive: \$$(TMPDIR)/index.html pages"
echo
echo "\$$(TMPDIR)/sitemap.xml.gz: "'$$'"(allposts) \$$(TMPDIR)/index.html $$pages"
echo "	ksh bin/sitemap "'$$'"(allposts) | gzip -c >tmp/sitemap.xml.gz"
echo
# create tags rules
for tag in $$(ls --quoting-style=shell -x $(CFGDIR)/tags/); do
	tags="$$tags tags/$${tag}"
	pagename="index.html"
	pages=""
	i=0
	set -A allposts $$(tr '\n' ' ' <$(CFGDIR)/tags/$${tag})
	pagecnt=$$(($${#allposts[@]} / $(maxposts) ))
	while [ $$i -le $${pagecnt} ]; do
		lbound=$$((i*$(maxposts) +1))
		ubound=$$((i*$(maxposts) +$(maxposts) ))
		next=$$((i+1))
		if [ $$next -lt $$pagecnt ]; then
		    nextpage="page-$$next.html"
		else
		    nextpage=""
		fi
		prev=$$((i-1))
		if [ $$prev -eq 0 ]; then
		    prevpage="index.html"
		elif [ $$prev -lt 0 ]; then
		    prevpage=""
		else
		    prevpage="page-$$prev.html"
		fi
		pages="$$pages \$$(TMPDIR)/tags/$${tag}/$${pagename}"
		echo "\$$(TMPDIR)/tags/$${tag}/$${pagename}: $${allposts[$$lbound,$$ubound]}"
   	echo "	@test -d \$$(@D) || mkdir -p \$$(@D)"
		echo "	ksh bin/page \"tags/$${tag}\" \"$$prevpage\" \"$$nextpage\" "'$$^'" >\$$@"
		echo
		i=$$((i + 1))
		pagename="page-$$i.html"
	done
	echo "tags/$${tag}: $$pages \$$(TMPDIR)/tags/$${tag}/atom.xml"
	echo
	echo "\$$(TMPDIR)/tags/$${tag}/atom.xml: $${allposts[1,$(maxposts)+1]}"
   echo "	@test -d \$$(@D) || mkdir -p \$$(@D)"
	echo "	ksh bin/atom \$$^ >\$$@"
	echo
done
echo "tags: $${tags}"
echo
#	create posts rules
i=1
set -A files $^
#. bin/utterson.lib
while [ $${#files[@]} -ge $$i ]; do
	#tname=posts/$$(f=$${files[i]##*posts/} ;echo $${f// /_} | urlencode)
	tname="$${files[i]}"
	echo "\$$(TMPDIR)/$${tname}: $${files[i]}"
   echo "	@test -d \$$(@D) || mkdir -p \$$(@D)"
	echo "	ksh bin/post \"$${files[i]}\" \"$${files[i-1]}\" \"$${files[i+1]}\" >\$$@\n"
	postpages="$$postpages \$$(TMPDIR)/$${tname}"
	i=$$((i+1))
done
echo "posts: $$postpages"
