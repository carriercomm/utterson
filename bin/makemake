#!/bin/ksh

. ${0%%/*}/utterson.lib

# this function creates rules for index.html+page-X...Z.html style archives
# in the directory specified by the first parameter
# for all posts read via stdin
function car {
	i=0
	pages=""
	pagename="index.html"
	set -A allposts $(tr '\n' ' ')
	pagecnt=$((${#allposts[@]} / ${ITEMMAX} ))
   # set targetdir
   subdir="$1"
   if [[ -z "$subdir" ]]; then
       target="\$(TMPDIR)"
       postlist="liveposts"
       ubertarget="echo archive: $postlist\$pages"
   else
       target="\$(TMPDIR)/${subdir}"
       postlist="${CFGDIR}/$subdir"
	    ubertarget="echo ${subdir}: $postlist\$pages \${target}/atom.xml"
   fi
	while [ $i -le ${pagecnt} ]; do
      # calculate range of items
		lbound=$((i*${ITEMMAX}+1))
		ubound=$((i*${ITEMMAX}+${ITEMMAX}))

      # set next page link
		next=$((i+1))
		if [ $next -le $pagecnt ]; then
		    nextpage="page-$next.html"
		else
		    nextpage=""
		fi

      # set previous link
		prev=$((i-1))
		if [ $prev -eq 0 ]; then
		    prevpage="index.html"
		elif [ $prev -lt 0 ]; then
		    prevpage=""
		else
		    prevpage="page-$prev.html"
		fi

		pages="$pages $target/${pagename}"
		echo "$target/${pagename}: \$(shell sed -n -e \"$lbound,$ubound p;$ubound q\" $postlist)"
   	echo "	@test -d \$(@D) || mkdir -p \$(@D)"
	   echo "	sed -n -e \"$lbound,$ubound p;$ubound q\" $postlist | ksh bin/page \"${subdir}\" \"$prevpage\" \"$nextpage\" >\$@"
		echo
		i=$((i + 1))
		pagename="page-$i.html"
	done
	echo "${target}/atom.xml: \$(shell head -$ITEMMAX $postlist)"
   echo "	@test -d \$(@D) || mkdir -p \$(@D)"
	echo "	head -$ITEMMAX $postlist | ksh bin/atom >\$@"
	echo
   eval "$ubertarget"
	echo
}

function postrules {
    read tname
    while true; do
        read nextf || nextf=""
	     print "\$(TMPDIR)/${tname}: ${tname}"
        print "	@test -d \$(@D) || mkdir -p \$(@D)"
	     print "	ksh bin/post \"${tname}\" \"$prevf\" \"$nextf\" >\$@\n"
	     postpages="$postpages \$(TMPDIR)/${tname}"
        [[ -z "$nextf" ]] && return
        prevf="${tname}"
        tname="${nextf}"
    done
}

# reproduce header
cp Makefile.in Makefile

# create main index archive rules
car "" <liveposts

# create tag rules
for tag in $(ls -x ${CFGDIR}/tags/); do
	tags="$tags tags/${tag}"
   car "tags/$tag" <${CFGDIR}/tags/${tag}
done
echo "tags: ${tags}"
echo

#	create individual posts rules
postrules <liveposts

echo "posts:$postpages"

echo "last: \$(TMPDIR)/$(head -1 liveposts)"
echo "2nd: \$(TMPDIR)/$(sed -n -e '2p;2q' liveposts)"
