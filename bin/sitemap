#!/usr/bin/ksh
# generates an atomfeed and static html blog pages from
# posts/*.html files, containing the entry content of the posts, the
# filename is used as a title, the last modification time as
# lastupdate.
#
# TODO tags, blog search

. ${0%%/*}/utterson.cfg
. ${0%%/*}/utterson.lib

########### start processing #############

postslen=${#@}

# get timestamp of very last post for rss
TVARS[LASTUPDATED]="$(getRFCtime "${1}")"

#### MAIN LOOP STARTS HERE ####

counter=0
# start sitemap
runtpl sitemap header >"${TMPDIR}/${SITEMAPFILE}"

# process posts
for entry; do
    fname="${entry##*/}"
    TVARS[POSTTITLE]="${fname%.html}"
    TVARS[POSTUPDATED]="$(getRFCtime "$entry")"
    TVARS[POSTUPDATEDSHORT]="$(stat -c "%y" "$entry" | cut -d" " -f1)"
    TVARS[POSTCONTENT]="$(filter "$entry")"
    TVARS[POSTURL]="posts/${fname// /_}"
    TVARS[PAGETITLE]="${TVARS[BLOGTITLE]} - ${TVARS[POSTTITLE]}"

    # WRITE sitemap entry for permalink
    TVARS[CHANGEFREQ]="monthly"
    TVARS[PAGEPRIO]="0.6"
    runtpl sitemap item >>"${TMPDIR}/${SITEMAPFILE}"

    counter=$((counter + 1))
done

# WRITE sitemap entry for index pages
TVARS[POSTUPDATEDSHORT]="$(date '+%Y-%m-%d')"
TVARS[CHANGEFREQ]="weekly"
[[ $((counter / ITEMMAX)) -eq 0 ]] &&
    TVARS[PAGEPRIO]="0.9"
[[ $((counter / ITEMMAX)) -gt 0 ]] &&
    TVARS[PAGEPRIO]="0.8"
runtpl sitemap item >>"${TMPDIR}/${SITEMAPFILE}"

runtpl sitemap footer >>"${TMPDIR}/${SITEMAPFILE}"
gzip "${TMPDIR}/${SITEMAPFILE}"
